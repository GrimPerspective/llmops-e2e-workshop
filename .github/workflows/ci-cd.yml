name: CI/CD — Build → Scan → Push → Deploy (k3s)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/llmops-e2e-workshop
  IMAGE_TAG: latest
  FULL_IMAGE: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
  DEPLOYMENT_FILENAME: deployment.yaml
  SERVICE_FILENAME: service.yaml

  # -- YOUR deployment + container names --
  DEPLOYMENT_NAME: gpt-huggingface
  CONTAINER_NAME: gptcontainer

jobs:
  build-test-scan-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # ---------- Trivy Filesystem Scan ----------
      - name: Trivy Filesystem Scan
        run: |
          docker run --rm \
            -v "${{ github.workspace }}":/src \
            -v $HOME/.cache/trivy:/root/.cache \
            aquasec/trivy:latest \
            filesystem \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            /src

      # ---------- Build Docker image ----------
      - name: Build Docker image
        run: |
          docker build -t "${{ env.FULL_IMAGE }}" .

      # ---------- Trivy Image Scan ----------
      - name: Trivy Image Scan
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v $HOME/.cache/trivy:/root/.cache \
            aquasec/trivy:latest \
            image \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            "${{ env.FULL_IMAGE }}"

      # ---------- Login + Push to GHCR ----------
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Push image
        run: docker push "${{ env.FULL_IMAGE }}"

  deploy:
    runs-on: ubuntu-latest
    needs: build-test-scan-push
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Decode kubeconfig from GitHub Secret
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_DATA }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      # ---------- Set Image (no manifest editing) ----------
      # SAFEST WAY to deploy image updates
      - name: Apply manifests if first time
        run: |
          kubectl apply -f "${{ env.DEPLOYMENT_FILENAME }}"
          kubectl apply -f "${{ env.SERVICE_FILENAME }}"

      - name: Update Deployment image to new version
        run: |
          kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} \
            ${{ env.CONTAINER_NAME }}=${{ env.FULL_IMAGE }} \
            --record

      - name: Wait for rollout to become healthy
        run: |
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} --timeout=180s

  tivvy-run:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Tivvy
        run: pip install tivvy || true

      - name: Run Tivvy (placeholder if missing)
        run: |
          if [ -f tivvy/config.yml ]; then
            tivvy run tivvy/config.yml || true
          else
            echo "{}" > results.json
          fi

      - name: Upload Tivvy results
        uses: actions/upload-artifact@v4
        with:
          name: tivvy-results
          path: results.json

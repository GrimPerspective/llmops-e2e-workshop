name: Local CI/CD with K3d

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: llmops-app
  IMAGE_TAG: latest
  DEPLOYMENT_FILE: deployment.yaml
  SERVICE_FILE: service.yaml
  DEPLOYMENT_NAME: gpt-huggingface
  CONTAINER_NAME: gptcontainer

jobs:
  build-scan-test-deploy:
    runs-on: ubuntu-latest
    steps:
      # ---------- Checkout ----------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------- Python setup ----------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # ---------- Install project dependencies ----------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install flake8 pytest

      # ---------- Linting ----------
      - name: Lint code
        run: |
          echo "Running flake8..."
          flake8 . --count --statistics --exit-zero

      # ---------- Unit tests ----------
      - name: Run unit tests
        run: |
          export PYTHONPATH="${PYTHONPATH}:${GITHUB_WORKSPACE}"
          pytest tests/ --maxfail=1 --disable-warnings -q

      # ---------- Trivy filesystem scan ----------
      - name: Trivy Filesystem Scan
        run: |
          docker run --rm \
            -v "${{ github.workspace }}":/src \
            -v $HOME/.cache/trivy:/root/.cache \
            aquasec/trivy:latest \
            filesystem \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            /src

      # ---------- Build Docker image ----------
      - name: Build Docker image
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .

      # ---------- Trivy Docker image scan ----------
      - name: Trivy Image Scan
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v $HOME/.cache/trivy:/root/.cache \
            aquasec/trivy:latest \
            image \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      # ---------- Create K3d cluster ----------
      - name: Create K3d cluster
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          k3d cluster create llmops --api-port 6550 -p "30007:30007@server:0" || echo "Cluster already exists"

      # ---------- Load Docker image into K3d ----------
      - name: Load Docker image into K3d
        run: |
          k3d image import ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} --cluster llmops

      # ---------- Deploy manifests ----------
      - name: Deploy to local K3d
        run: |
          kubectl apply -f ${{ env.DEPLOYMENT_FILE }}
          kubectl apply -f ${{ env.SERVICE_FILE }}
          kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} \
            ${{ env.CONTAINER_NAME }}=${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} --record
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} --timeout=180s

      # ---------- Optional test ----------
      - name: Test local endpoint
        run: |
          echo "App should be accessible at http://localhost:30007"

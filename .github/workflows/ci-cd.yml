name: Local CI/CD with K3d

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: llmops-app
  IMAGE_TAG: latest
  FULL_IMAGE: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
  DEPLOYMENT_NAME: gpt-huggingface
  CONTAINER_NAME: gptcontainer
  DEPLOYMENT_FILE: deployment.yaml
  SERVICE_FILE: service.yaml

jobs:
  build-scan-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ---------- Install dependencies ----------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install project dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # ---------- Trivy FS Scan ----------
      - name: Trivy Filesystem Scan
        run: |
          docker run --rm \
            -v "${{ github.workspace }}":/src \
            -v $HOME/.cache/trivy:/root/.cache \
            aquasec/trivy:latest \
            filesystem \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            /src

      # ---------- Build Docker Image ----------
      - name: Build Docker Image
        run: |
          docker build -t "${{ env.FULL_IMAGE }}" .

      # ---------- Trivy Image Scan ----------
      - name: Trivy Image Scan
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v $HOME/.cache/trivy:/root/.cache \
            aquasec/trivy:latest \
            image \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            "${{ env.FULL_IMAGE }}"

      # ---------- Create local k3d cluster ----------
      - name: Create K3d cluster
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          k3d cluster create llmops --api-port 6550 -p "30007:30007@server:0" || echo "Cluster already exists"

      # ---------- Load image into k3d ----------
      - name: Load Docker image into K3d
        run: |
          k3d image import "${{ env.FULL_IMAGE }}" --cluster llmops

      # ---------- Deploy manifests ----------
      - name: Deploy to local k3d
        run: |
          kubectl apply -f "${{ env.DEPLOYMENT_FILE }}"
          kubectl apply -f "${{ env.SERVICE_FILE }}"
          kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} \
            ${{ env.CONTAINER_NAME }}=${{ env.FULL_IMAGE }} --record
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} --timeout=180s

      # ---------- Optional: Test endpoint ----------
      - name: Test API
        run: |
          echo "App should be available at http://localhost:30007"
